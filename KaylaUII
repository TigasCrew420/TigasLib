local UIS = game:GetService("UserInputService")
local __KAYLA_IS_MOBILE = UIS.TouchEnabled and not UIS.KeyboardEnabled and not UIS.MouseEnabled
local __KAYLA_DEVICE_OVERRIDE = nil
local function Kayla_GetDevice()
    if __KAYLA_DEVICE_OVERRIDE then
        return __KAYLA_DEVICE_OVERRIDE
    end
    return __KAYLA_IS_MOBILE and "Mobile" or "PC"
end

if __KAYLA_IS_MOBILE then
    local cg = (gethui and gethui()) or game:GetService("CoreGui")
    local gui = Instance.new("ScreenGui")
    gui.Name = "KaylaUI_DeviceChooser"
    gui.IgnoreGuiInset = true
    gui.ResetOnSpawn = false
    gui.Parent = cg

    local f = Instance.new("Frame", gui)
    f.Size = UDim2.fromScale(0.6, 0.25)
    f.Position = UDim2.fromScale(0.2, 0.375)
    f.BackgroundColor3 = Color3.fromRGB(18,18,20)
    f.BorderSizePixel = 0
    Instance.new("UICorner", f)

    local t = Instance.new("TextLabel", f)
    t.Size = UDim2.fromScale(1, 0.35)
    t.BackgroundTransparency = 1
    t.Text = "Choose UI Mode"
    t.Font = Enum.Font.GothamBold
    t.TextSize = 20
    t.TextColor3 = Color3.new(1,1,1)

    local function btn(txt, mode, pos)
        local b = Instance.new("TextButton", f)
        b.Size = UDim2.fromScale(0.42, 0.45)
        b.Position = pos
        b.Text = txt
        b.Font = Enum.Font.GothamBold
        b.TextSize = 18
        b.BackgroundColor3 = Color3.fromRGB(35,35,40)
        b.TextColor3 = Color3.new(1,1,1)
        b.BorderSizePixel = 0
        Instance.new("UICorner", b)
        b.MouseButton1Click:Connect(function()
            __KAYLA_DEVICE_OVERRIDE = mode
            gui:Destroy()
        end)
    end

    btn("ðŸ“± Mobile", "Mobile", UDim2.fromScale(0.05, 0.45))
    btn("ðŸ’» PC", "PC", UDim2.fromScale(0.53, 0.45))

    repeat task.wait() until __KAYLA_DEVICE_OVERRIDE
end

local Players      = game:GetService("Players")
local UIS          = game:GetService("UserInputService")
local RunService   = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local HttpService  = game:GetService("HttpService")

local LocalPlayer  = Players.LocalPlayer
local PlayerGui    = LocalPlayer and LocalPlayer:FindFirstChildOfClass("PlayerGui")

local CONFIG_FOLDER       = "KaylaUI"
local DEFAULT_CONFIG_NAME = "default"

local KaylaUI   = {}
KaylaUI.__index = KaylaUI
local Window    = {}
Window.__index  = Window
local Tab       = {}
Tab.__index     = Tab
local Section   = {}
Section.__index = Section

KaylaUI.Theme = {
    Background = Color3.fromRGB(13, 13, 15),
    Topbar     = Color3.fromRGB(18, 18, 20),
    Accent     = Color3.fromRGB(210, 210, 210),
    Accent2    = Color3.fromRGB(120, 120, 130),
    Section    = Color3.fromRGB(20, 20, 23),
    Outline    = Color3.fromRGB(45, 45, 52),
    Text       = Color3.fromRGB(235, 235, 245),
    TextDim    = Color3.fromRGB(150, 150, 170),
    Font       = Enum.Font.Code,
}

KaylaUI._Windows  = {}
KaylaUI._Controls = {}

local function GetGuiParent()
    if PlayerGui then return PlayerGui end
    local ok, CoreGui = pcall(function()
        return game:GetService("CoreGui")
    end)
    if ok and CoreGui then return CoreGui end
    return workspace
end

local function New(className, props)
    local obj = Instance.new(className)
    props = props or {}
    local children = props.Children

    for k, v in pairs(props) do
        if k ~= "Children" and k ~= "Parent" then
            obj[k] = v
        end
    end
    if children then
        for _, child in ipairs(children) do
            child.Parent = obj
        end
    end
    if props.Parent then obj.Parent = props.Parent end
    return obj
end

function KaylaUI:_RegisterControl(info)
    if not info or not info.Flag then return end
    table.insert(self._Controls, info)
end

KaylaUI._NotiGui    = nil
KaylaUI._NotiHolder = nil

function KaylaUI:_EnsureNotiGui()
    if self._NotiGui then return self._NotiGui end

    local gui = New("ScreenGui", {
        Name = "KaylaUI_Notifications",
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Global,
        Parent = GetGuiParent(),
    })

    local holder = New("Frame", {
        Name = "Holder",
        Parent = gui,
        AnchorPoint = Vector2.new(1, 1),
        Position = UDim2.new(1, -10, 1, -10),
        Size = UDim2.new(0, 300, 1, -20),
        BackgroundTransparency = 1,
        Children = {
            New("UIListLayout", {
                FillDirection = Enum.FillDirection.Vertical,
                SortOrder = Enum.SortOrder.LayoutOrder,
                Padding = UDim.new(0, 6),
                HorizontalAlignment = Enum.HorizontalAlignment.Right,
                VerticalAlignment = Enum.VerticalAlignment.Bottom,
            })
        }
    })

    self._NotiGui    = gui
    self._NotiHolder = holder
    return gui
end

function KaylaUI:Notify(title, text, duration)
    duration = duration or 4
    self:_EnsureNotiGui()

    local frame = New("Frame", {
        Parent = self._NotiHolder,
        BackgroundColor3 = KaylaUI.Theme.Section,
        Size = UDim2.new(0, 260, 0, 0),
        BorderSizePixel = 0,
        ClipsDescendants = true,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(0, 6) }),
            New("UIStroke", { Color = KaylaUI.Theme.Outline, Thickness = 1 }),
        }
    })

    local titleLabel = New("TextLabel", {
        Parent = frame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 4),
        Size = UDim2.new(1, -16, 0, 18),
        Font = KaylaUI.Theme.Font,
        Text = title or "Notification",
        TextColor3 = KaylaUI.Theme.Text,
        TextSize = 15,
        TextXAlignment = Enum.TextXAlignment.Left,
    })

    local textLabel = New("TextLabel", {
        Parent = frame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 22),
        Size = UDim2.new(1, -16, 0, 14),
        Font = KaylaUI.Theme.Font,
        Text = text or "",
        TextColor3 = KaylaUI.Theme.TextDim,
        TextSize = 13,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextWrapped = true,
    })

    local textBounds = game:GetService("TextService"):GetTextSize(
        textLabel.Text,
        textLabel.TextSize,
        textLabel.Font,
        Vector2.new(textLabel.AbsoluteSize.X, 1000)
    )
    local sizeY = math.max(40, 26 + textBounds.Y)

    TweenService:Create(frame, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
        Size = UDim2.new(0, 260, 0, sizeY)
    }):Play()

    task.spawn(function()
        task.wait(duration)
        TweenService:Create(frame, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
            Size = UDim2.new(0, 260, 0, 0),
            BackgroundTransparency = 1
        }):Play()
        task.wait(0.3)
        frame:Destroy()
    end)
end

function KaylaUI:SetAccent(color)
    KaylaUI.Theme.Accent = color
    for _, win in ipairs(self._Windows) do
        if win._UpdateTheme then
            win:_UpdateTheme()
        end
    end
end

local function ensureFolder()
    if not isfolder then return end
    if not isfolder(CONFIG_FOLDER) then
        pcall(makefolder, CONFIG_FOLDER)
    end
end

function KaylaUI:_GetConfigPath(name)
    name = name or DEFAULT_CONFIG_NAME
    return CONFIG_FOLDER .. "/" .. name .. ".json"
end

function KaylaUI:SaveConfig(name)
    name = name or DEFAULT_CONFIG_NAME
    if not writefile then
        self:Notify("Config", "writefile not supported by executor.", 5)
        return
    end

    ensureFolder()
    local data = {}
    for _, control in ipairs(self._Controls or {}) do
        if control.Flag and control.Get then
            local value = control.Get()
            if control.Type == "color" and typeof(value) == "Color3" then
                value = {value.R, value.G, value.B}
            elseif control.Type == "keybind" and typeof(value) == "EnumItem" then
                value = value.Name
            end
            data[control.Flag] = value
        end
    end

    local json
    local ok, err = pcall(function()
        json = HttpService:JSONEncode(data)
    end)
    if not ok then
        self:Notify("Config Error", "Failed to encode JSON: " .. tostring(err), 5)
        return
    end

    local path = self:_GetConfigPath(name)
    pcall(writefile, path, json)
    self:Notify("Config", "Saved config: " .. name, 4)
end

function KaylaUI:LoadConfig(name)
    name = name or DEFAULT_CONFIG_NAME
    if not readfile or not isfile then
        self:Notify("Config", "readfile/isfile not supported by executor.", 5)
        return
    end

    local path = self:_GetConfigPath(name)
    if not isfile(path) then
        self:Notify("Config", "Config not found: " .. name, 4)
        return
    end

    local content
    local ok, err = pcall(function()
        content = readfile(path)
    end)
    if not ok or not content then
        self:Notify("Config", "Failed reading config.", 4)
        return
    end

    local decoded
    ok, decoded = pcall(function()
        return HttpService:JSONDecode(content)
    end)
    if not ok or type(decoded) ~= "table" then
        self:Notify("Config", "Invalid config JSON.", 4)
        return
    end

    for _, control in ipairs(self._Controls or {}) do
        if control.Flag and control.Set and decoded[control.Flag] ~= nil then
            local val = decoded[control.Flag]
            pcall(function()
                if control.Type == "color" and type(val) == "table" and #val == 3 then
                    control.Set(Color3.new(val[1], val[2], val[3]))
                elseif control.Type == "keybind" and type(val) == "string" and Enum.KeyCode[val] then
                    control.Set(Enum.KeyCode[val])
                else
                    control.Set(val)
                end
            end)
        end
    end

    self:Notify("Config", "Loaded config: " .. name, 4)
end

function KaylaUI:CreateWindow(opts)
    opts = opts or {}
    local title     = opts.Title or "KaylaUI"
    local size      = opts.Size or UDim2.fromOffset(560, 360)
    local toggleKey = opts.ToggleKey or Enum.KeyCode.RightControl
    local id        = opts.Id or title
    local showBlur  = opts.ShowBlur
    local footerTxt = opts.FooterText or ("[" .. toggleKey.Name .. "] to toggle")

    local screenGui = New("ScreenGui", {
        Name = "KaylaUI_Main",
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Global,
        Parent = GetGuiParent(),
    })

    local blur
    if showBlur then
        blur = Instance.new("BlurEffect")
        blur.Size = 18
        blur.Name = "KaylaUI_Blur"
        blur.Parent = game:GetService("Lighting")
    end

    local mainFrame = New("Frame", {
        Parent = screenGui,
        Size = size,
        Position = UDim2.new(0.5, -size.X.Offset / 2, 0.5, -size.Y.Offset / 2),
        BackgroundColor3 = KaylaUI.Theme.Background,
        BorderSizePixel = 0,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(0, 8) }),
            New("UIStroke", { Color = KaylaUI.Theme.Outline, Thickness = 1 }),
        }
    })

    local topbar = New("Frame", {
        Parent = mainFrame,
        Size = UDim2.new(1, 0, 0, 32),
        BackgroundColor3 = KaylaUI.Theme.Topbar,
        BorderSizePixel = 0,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(0, 8) }),
        }
    })

    local titleLabel = New("TextLabel", {
        Parent = topbar,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0, 0),
        Size = UDim2.new(0.5, -10, 1, 0),
        Text = title,
        Font = KaylaUI.Theme.Font,
        TextColor3 = KaylaUI.Theme.Text,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextSize = 16,
    })

    local hintLabel = New("TextLabel", {
        Parent = topbar,
        BackgroundTransparency = 1,
        AnchorPoint = Vector2.new(1, 0),
        Position = UDim2.new(1, -10, 0, 0),
        Size = UDim2.new(0, 200, 1, 0),
        Text = footerTxt,
        Font = KaylaUI.Theme.Font,
        TextColor3 = KaylaUI.Theme.TextDim,
        TextXAlignment = Enum.TextXAlignment.Right,
        TextSize = 13,
    })

    local contentHolder = New("Frame", {
        Parent = mainFrame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 32),
        Size = UDim2.new(1, 0, 1, -32),
    })

    local tabsBar = New("Frame", {
        Parent = contentHolder,
        Size = UDim2.new(0, 160, 1, 0),
        BackgroundColor3 = Color3.fromRGB(16,16,18),
        BorderSizePixel = 0,
        Children = {
            New("UIPadding", {
                PaddingTop = UDim.new(0, 8),
                PaddingLeft = UDim.new(0, 8),
                PaddingRight = UDim.new(0, 8),
            }),
            New("UIListLayout", {
                FillDirection = Enum.FillDirection.Vertical,
                SortOrder = Enum.SortOrder.LayoutOrder,
                Padding = UDim.new(0, 4),
            }),
        }
    })

    local tabContentArea = New("Frame", {
        Parent = contentHolder,
        Position = UDim2.new(0, 160, 0, 4),
        Size = UDim2.new(1, -164, 1, -8),
        BackgroundTransparency = 1,
    })

    local tabHolder = New("Frame", {
        Parent = tabContentArea,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
    })

    local windowObj = setmetatable({
        _Gui       = screenGui,
        _Main      = mainFrame,
        _Topbar    = topbar,
        _TabsBar   = tabsBar,
        _TabHolder = tabHolder,
        _Tabs      = {},
        _ActiveTab = nil,
        _Visible   = true,
        ToggleKey  = toggleKey,
        _Id        = id,
        _Blur      = blur,
    }, Window)

    table.insert(KaylaUI._Windows, windowObj)

    -- Dragging
    do
        local dragging = false
        local dragStart, startPos

        topbar.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                dragStart = input.Position
                startPos = mainFrame.Position
            end
        end)

        topbar.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)

        UIS.InputChanged:Connect(function(input)
            if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                local delta = input.Position - dragStart
                mainFrame.Position = UDim2.new(
                    startPos.X.Scale, startPos.X.Offset + delta.X,
                    startPos.Y.Scale, startPos.Y.Offset + delta.Y
                )
            end
        end)
    end

    -- Toggle visibility
    UIS.InputBegan:Connect(function(input, gp)
        if gp then return end
        if input.KeyCode == toggleKey then
            windowObj:SetVisible(not windowObj._Visible)
        end
    end)

    return windowObj
end

function Window:SetVisible(v)
    self._Visible = v and true or false
    if self._Gui then self._Gui.Enabled = self._Visible end
    if self._Blur then self._Blur.Enabled = self._Visible end
end

function Window:_UpdateTheme()
    for _, tab in ipairs(self._Tabs) do
        if tab._Button then
            local btn = tab._Button
            local title = btn:FindFirstChild("Title")
            if self._ActiveTab == tab then
                btn.BackgroundColor3 = KaylaUI.Theme.Accent2
                if title then title.TextColor3 = KaylaUI.Theme.Text end
            else
                btn.BackgroundColor3 = Color3.fromRGB(23,23,26)
                if title then title.TextColor3 = KaylaUI.Theme.Text end
            end
        end
        if tab._Page and tab._Page:IsA("ScrollingFrame") then
            tab._Page.ScrollBarImageColor3 = KaylaUI.Theme.Accent
        end
        for _, sec in ipairs(tab._Sections or {}) do
            if sec._UpdateTheme then sec:_UpdateTheme() end
        end
    end
end

function Window:_SetActiveTab(tabObj)
    if self._ActiveTab == tabObj then return end
    self._ActiveTab = tabObj

    for _, tab in ipairs(self._Tabs) do
        if tab._Button then
            local btn = tab._Button
            local title = btn:FindFirstChild("Title")
            local target = (tab == tabObj) and KaylaUI.Theme.Accent2 or Color3.fromRGB(23,23,26)
            TweenService:Create(btn, TweenInfo.new(0.15), {
                BackgroundColor3 = target
            }):Play()
            if title then
                title.TextColor3 = KaylaUI.Theme.Text
            end
        end
        if tab._Page then
            tab._Page.Visible = (tab == tabObj)
        end
    end
end

-- Usage:
--   Window:AddTab("Main", "rbxassetid://123456")
-- or:
--   Window:AddTab({ Name = "Main", Icon = "rbxassetid://123456" })
function Window:AddTab(nameOrOpts, iconId)
    local name = nameOrOpts
    local icon = iconId

    if type(nameOrOpts) == "table" then
        name = nameOrOpts.Name or "Tab"
        icon = nameOrOpts.Icon
    end

    name = name or "Tab"

    local button = New("TextButton", {
        Parent = self._TabsBar,
        Size = UDim2.new(1, 0, 0, 28),
        BackgroundColor3 = Color3.fromRGB(23,23,26),
        BorderSizePixel = 0,
        Text = "",
        AutoButtonColor = false,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(0, 6) }),
            New("UIPadding", {
                PaddingLeft = UDim.new(0, 6),
                PaddingRight = UDim.new(0, 6),
            }),
            New("UIListLayout", {
                FillDirection = Enum.FillDirection.Horizontal,
                SortOrder = Enum.SortOrder.LayoutOrder,
                VerticalAlignment = Enum.VerticalAlignment.Center,
                Padding = UDim.new(0, 6),
            }),
            icon and New("ImageLabel", {
                Name = "Icon",
                BackgroundTransparency = 1,
                Size = UDim2.new(0, 16, 0, 16),
                Image = icon,
                ImageColor3 = KaylaUI.Theme.TextDim,
            }) or nil,
            New("TextLabel", {
                Name = "Title",
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 1, 0),
                Font = KaylaUI.Theme.Font,
                Text = name,
                TextColor3 = KaylaUI.Theme.Text,
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left,
            })
        }
    })

    button.MouseEnter:Connect(function()
        if self._ActiveTab and self._ActiveTab._Button == button then return end
        TweenService:Create(button, TweenInfo.new(0.12), {
            BackgroundColor3 = Color3.fromRGB(35,35,40)
        }):Play()
    end)
    button.MouseLeave:Connect(function()
        if self._ActiveTab and self._ActiveTab._Button == button then return end
        TweenService:Create(button, TweenInfo.new(0.12), {
            BackgroundColor3 = Color3.fromRGB(23,23,26)
        }):Play()
    end)

    local page = New("ScrollingFrame", {
        Parent = self._TabHolder,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = KaylaUI.Theme.Section,
        BorderSizePixel = 0,
        Visible = false,
        ClipsDescendants = true,
        ScrollingDirection = Enum.ScrollingDirection.Y,
        ScrollBarImageColor3 = KaylaUI.Theme.Accent,
        ScrollBarThickness = 4,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(0, 8) }),
            New("UIPadding", {
                PaddingTop = UDim.new(0, 8),
                PaddingLeft = UDim.new(0, 10),
                PaddingRight = UDim.new(0, 10),
                PaddingBottom = UDim.new(0, 8),
            }),
            New("UIListLayout", {
                FillDirection = Enum.FillDirection.Vertical,
                SortOrder = Enum.SortOrder.LayoutOrder,
                Padding = UDim.new(0, 8),
            })
        }
    })

    local tabObj = setmetatable({
        _Window   = self,
        _Button   = button,
        _Page     = page,
        _Sections = {},
        _Name     = name,
    }, Tab)

    table.insert(self._Tabs, tabObj)

    button.MouseButton1Click:Connect(function()
        self:_SetActiveTab(tabObj)
    end)

    if not self._ActiveTab then
        self:_SetActiveTab(tabObj)
    end

    return tabObj
end

function Tab:AddSection(name)
    name = name or "Section"

    local frame = New("Frame", {
        Parent = self._Page,
        AutomaticSize = Enum.AutomaticSize.Y,
        Size = UDim2.new(1, 0, 0, 0),
        BackgroundColor3 = KaylaUI.Theme.Background,
        BorderSizePixel = 0,
        ClipsDescendants = true,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(0, 6) }),
            New("UIStroke", { Color = KaylaUI.Theme.Outline, Thickness = 1 }),
        }
    })

    local title = New("TextLabel", {
        Parent = frame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 4),
        Size = UDim2.new(1, -16, 0, 18),
        Font = KaylaUI.Theme.Font,
        Text = name,
        TextColor3 = KaylaUI.Theme.TextDim,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
    })

    local inner = New("Frame", {
        Parent = frame,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 24),
        Size = UDim2.new(1, -16, 0, 0),
        AutomaticSize = Enum.AutomaticSize.Y,
        Children = {
            New("UIListLayout", {
                FillDirection = Enum.FillDirection.Vertical,
                SortOrder = Enum.SortOrder.LayoutOrder,
                Padding = UDim.new(0, 4),
            })
        }
    })
    New("Frame", {
        Parent = inner,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 2),
    })

    local sectionObj = setmetatable({
        _Tab   = self,
        _Frame = frame,
        _Inner = inner,
    }, Section)

    function sectionObj:_UpdateTheme() end

    table.insert(self._Sections, sectionObj)
    return sectionObj
end

local function makeFlag(section, controlText, suffix, opts)
    opts = opts or {}
    if opts.Flag then return opts.Flag end
    suffix = suffix or ""
    local win = section._Tab._Window
    local tab = section._Tab
    local wId = win._Id or "Window"
    local tId = tab._Name or "Tab"
    local cId = controlText or "Control"
    return wId .. "." .. tId .. "." .. cId .. "." .. suffix
end

function Section:AddLabel(text)
    local label = New("TextLabel", {
        Parent = self._Inner,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 18),
        Font = KaylaUI.Theme.Font,
        Text = text or "Label",
        TextColor3 = KaylaUI.Theme.Text,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
    })
    return label
end

function Section:AddSeparator()
    local line = New("Frame", {
        Parent = self._Inner,
        BackgroundColor3 = KaylaUI.Theme.Outline,
        Size = UDim2.new(1, 0, 0, 1),
        BorderSizePixel = 0,
    })
    return line
end

function Section:AddButton(text, callback)
    callback = callback or function() end
    local btn = New("TextButton", {
        Parent = self._Inner,
        Size = UDim2.new(1, 0, 0, 24),
        BackgroundColor3 = Color3.fromRGB(26,26,30),
        BorderSizePixel = 0,
        Text = text or "Button",
        Font = KaylaUI.Theme.Font,
        TextColor3 = KaylaUI.Theme.Text,
        TextSize = 14,
        AutoButtonColor = false,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(0, 6) }),
        }
    })

    btn.MouseEnter:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.1), {
            BackgroundColor3 = Color3.fromRGB(33,33,38)
        }):Play()
    end)
    btn.MouseLeave:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.1), {
            BackgroundColor3 = Color3.fromRGB(26,26,30)
        }):Play()
    end)

    btn.MouseButton1Click:Connect(function()
        task.spawn(callback)
    end)

    return btn
end

function Section:AddToggle(text, default, callback, opts)
    callback = callback or function() end
    opts = opts or {}
    local state = default and true or false

    local holder = New("Frame", {
        Parent = self._Inner,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 22),
    })

    local label = New("TextLabel", {
        Parent = holder,
        BackgroundTransparency = 1,
        Size = UDim2.new(0.7, 0, 1, 0),
        Font = KaylaUI.Theme.Font,
        Text = text or "Toggle",
        TextColor3 = KaylaUI.Theme.Text,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
    })

    local switch = New("Frame", {
        Parent = holder,
        AnchorPoint = Vector2.new(1, 0.5),
        Position = UDim2.new(1, 0, 0.5, 0),
        Size = UDim2.new(0, 40, 0, 18),
        BackgroundColor3 = Color3.fromRGB(35,35,40),
        BorderSizePixel = 0,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(1, 0) }),
        }
    })

    local circle = New("Frame", {
        Parent = switch,
        Size = UDim2.new(0, 16, 0, 16),
        Position = UDim2.new(state and 1 or 0, state and -16 or 0, 0.5, -8),
        BackgroundColor3 = state and KaylaUI.Theme.Accent or Color3.fromRGB(70,70,75),
        BorderSizePixel = 0,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(1, 0) }),
        }
    })

    local click = New("TextButton", {
        Parent = switch,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Text = "",
    })

    local function Set(v)
        state = v and true or false
        TweenService:Create(circle, TweenInfo.new(0.12), {
            Position = UDim2.new(state and 1 or 0, state and -16 or 0, 0.5, -8),
            BackgroundColor3 = state and KaylaUI.Theme.Accent or Color3.fromRGB(70,70,75),
        }):Play()
        task.spawn(callback, state)
    end

    click.MouseButton1Click:Connect(function()
        Set(not state)
    end)

    Set(state)

    local flag = makeFlag(self, text or "Toggle", "Toggle", opts)
    KaylaUI:_RegisterControl({
        Flag = flag,
        Type = "toggle",
        Get = function() return state end,
        Set = Set,
    })

    return {
        Set = Set,
        Get = function() return state end
    }
end

function Section:AddSlider(text, min, max, default, callback, opts)
    callback = callback or function() end
    opts     = opts or {}
    min      = min or 0
    max      = max or 100
    default  = default or min

    local value = math.clamp(default, min, max)

    local holder = New("Frame", {
        Parent = self._Inner,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 32),
    })

    local label = New("TextLabel", {
        Parent = holder,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 16),
        Font = KaylaUI.Theme.Font,
        Text = (text or "Slider") .. " : " .. tostring(value),
        TextColor3 = KaylaUI.Theme.Text,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
    })

    local barBack = New("Frame", {
        Parent = holder,
        BackgroundColor3 = Color3.fromRGB(30, 30, 35),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 20),
        Size = UDim2.new(1, 0, 0, 10),
        Children = {
            New("UICorner", { CornerRadius = UDim.new(1, 0) }),
        }
    })

    local barFill = New("Frame", {
        Parent = barBack,
        BackgroundColor3 = KaylaUI.Theme.Accent,
        BorderSizePixel = 0,
        Size = UDim2.new((value - min) / (max - min), 0, 1, 0),
        Children = {
            New("UICorner", { CornerRadius = UDim.new(1, 0) }),
        }
    })

    local dragging = false

    local function SetValueFromX(x)
        local absPos  = barBack.AbsolutePosition.X
        local absSize = barBack.AbsoluteSize.X
        local alpha   = math.clamp((x - absPos) / absSize, 0, 1)
        value = math.floor(min + (max - min) * alpha + 0.5)
        barFill.Size = UDim2.new((value - min) / (max - min), 0, 1, 0)
        label.Text   = (text or "Slider") .. " : " .. tostring(value)
        task.spawn(callback, value)
    end

    barBack.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            SetValueFromX(input.Position.X)
        end
    end)

    barBack.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)

    UIS.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            SetValueFromX(input.Position.X)
        end
    end)

    local function Set(v)
        v = math.floor(math.clamp(v, min, max) + 0.5)
        value = v
        barFill.Size = UDim2.new((value - min) / (max - min), 0, 1, 0)
        label.Text = (text or "Slider") .. " : " .. tostring(value)
        task.spawn(callback, value)
    end

    Set(value)

    local flag = makeFlag(self, text or "Slider", "Slider", opts)
    KaylaUI:_RegisterControl({
        Flag = flag,
        Type = "slider",
        Get = function() return value end,
        Set = Set,
    })

    return {
        Set = Set,
        Get = function() return value end
    }
end

function Section:AddDropdown(text, list, default, callback, opts)
    callback = callback or function() end
    opts     = opts or {}
    list     = list or {}
    default  = default or list[1]

    local opened   = false
    local selected = default or "None"

    local holder = New("Frame", {
        Parent = self._Inner,
        BackgroundColor3 = Color3.fromRGB(26,26,30),
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 24),
        ClipsDescendants = true,
        LayoutOrder = 1,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(0, 6) }),
        }
    })

    local label = New("TextLabel", {
        Parent = holder,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0, 0),
        Size = UDim2.new(1, -24, 1, 0),
        Font = KaylaUI.Theme.Font,
        Text = string.format("%s: %s", text or "Dropdown", tostring(selected)),
        TextColor3 = KaylaUI.Theme.Text,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
    })

    local arrow = New("TextLabel", {
        Parent = holder,
        BackgroundTransparency = 1,
        AnchorPoint = Vector2.new(1, 0),
        Position = UDim2.new(1, -4, 0, 0),
        Size = UDim2.new(0, 16, 1, 0),
        Font = KaylaUI.Theme.Font,
        Text = "â–¼",
        TextColor3 = KaylaUI.Theme.TextDim,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Center,
    })

    local itemHolder = New("Frame", {
        Parent = holder,
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 4, 0, 24),
        Size = UDim2.new(1, -8, 0, (#list * 22)),
        ClipsDescendants = true,
        Children = {
            New("UIListLayout", {
                SortOrder = Enum.SortOrder.LayoutOrder,
                Padding = UDim.new(0, 2),
            })
        }
    })

    local function SetOpen(state)
        opened = state
        holder.LayoutOrder = opened and -1 or 1
        local itemHeight = 22
        local newY = 24 + (#list * itemHeight)
        TweenService:Create(holder, TweenInfo.new(0.15), {
            Size = UDim2.new(1, 0, 0, opened and newY or 24)
        }):Play()
        arrow.Text = opened and "â–²" or "â–¼"
    end

    local function SetSelected(val)
        selected = val
        label.Text = string.format("%s: %s", text or "Dropdown", tostring(selected))
        task.spawn(callback, selected)
    end

    for _, v in ipairs(list) do
        local btn = New("TextButton", {
            Parent = itemHolder,
            Size = UDim2.new(1, 0, 0, 20),
            BackgroundColor3 = Color3.fromRGB(35,35,40),
            BorderSizePixel = 0,
            Text = tostring(v),
            Font = KaylaUI.Theme.Font,
            TextColor3 = KaylaUI.Theme.Text,
            TextSize = 13,
            AutoButtonColor = false,
            Children = {
                New("UICorner", { CornerRadius = UDim.new(0, 4) }),
            }
        })
        btn.MouseButton1Click:Connect(function()
            SetSelected(v)
            SetOpen(false)
        end)
    end

    New("TextButton", {
        Parent = holder,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 24),
        Text = "",
    }).MouseButton1Click:Connect(function()
        SetOpen(not opened)
    end)

    if default then task.spawn(callback, default) end

    local flag = makeFlag(self, text or "Dropdown", "Dropdown", opts)
    KaylaUI:_RegisterControl({
        Flag = flag,
        Type = "dropdown",
        Get = function() return selected end,
        Set = function(val) SetSelected(val) end,
    })

    return {
        Set     = SetSelected,
        Get     = function() return selected end,
        SetOpen = SetOpen,
    }
end

function Section:AddTextbox(text, placeholder, callback, opts)
    callback = callback or function() end
    opts = opts or {}

    local holder = New("Frame", {
        Parent = self._Inner,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 38),
    })

    local label = New("TextLabel", {
        Parent = holder,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 16),
        Font = KaylaUI.Theme.Font,
        Text = text or "Textbox",
        TextColor3 = KaylaUI.Theme.Text,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
    })

    local box = New("TextBox", {
        Parent = holder,
        BackgroundColor3 = Color3.fromRGB(30, 30, 40),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 16),
        Size = UDim2.new(1, 0, 0, 20),
        Font = KaylaUI.Theme.Font,
        Text = "",
        PlaceholderText = placeholder or "",
        PlaceholderColor3 = KaylaUI.Theme.TextDim,
        TextColor3 = KaylaUI.Theme.Text,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(0, 6) }),
            New("UIPadding", {
                PaddingLeft = UDim.new(0, 4),
                PaddingRight = UDim.new(0, 4),
            })
        }
    })

    box.FocusLost:Connect(function(enter)
        if enter then
            task.spawn(callback, box.Text)
        end
    end)

    local flag = makeFlag(self, text or "Textbox", "Textbox", opts)
    KaylaUI:_RegisterControl({
        Flag = flag,
        Type = "textbox",
        Get = function() return box.Text end,
        Set = function(val)
            box.Text = tostring(val or "")
        end,
    })

    return box
end

function Section:AddKeybind(text, defaultKey, callback, opts)
    callback = callback or function() end
    opts = opts or {}
    defaultKey = defaultKey or Enum.KeyCode.F

    local waiting = false
    local currentKey = defaultKey

    local holder = New("Frame", {
        Parent = self._Inner,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 22),
    })

    local label = New("TextLabel", {
        Parent = holder,
        BackgroundTransparency = 1,
        Size = UDim2.new(0.5, 0, 1, 0),
        Font = KaylaUI.Theme.Font,
        Text = text or "Keybind",
        TextColor3 = KaylaUI.Theme.Text,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
    })

    local button = New("TextButton", {
        Parent = holder,
        AnchorPoint = Vector2.new(1, 0),
        Position = UDim2.new(1, 0, 0, 0),
        Size = UDim2.new(0.45, 0, 1, 0),
        BackgroundColor3 = Color3.fromRGB(30, 30, 40),
        BorderSizePixel = 0,
        Text = currentKey.Name,
        Font = KaylaUI.Theme.Font,
        TextColor3 = KaylaUI.Theme.Text,
        TextSize = 14,
        AutoButtonColor = false,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(0, 6) }),
        }
    })

    button.MouseButton1Click:Connect(function()
        if waiting then return end
        waiting = true
        button.Text = "Press key..."
        local conn
        conn = UIS.InputBegan:Connect(function(input, gp)
            if gp then return end
            if input.KeyCode ~= Enum.KeyCode.Unknown then
                currentKey = input.KeyCode
                button.Text = currentKey.Name
                waiting = false
                conn:Disconnect()
            end
        end)
    end)

    UIS.InputBegan:Connect(function(input, gp)
        if gp or waiting then return end
        if input.KeyCode == currentKey then
            task.spawn(callback)
        end
    end)

    local function Set(key)
        if typeof(key) == "EnumItem" then
            currentKey = key
            button.Text = currentKey.Name
        end
    end

    Set(currentKey)

    local flag = makeFlag(self, text or "Keybind", "Keybind", opts)
    KaylaUI:_RegisterControl({
        Flag = flag,
        Type = "keybind",
        Get = function() return currentKey end,
        Set = Set,
    })

    return {
        Get = function() return currentKey end,
        Set = Set
    }
end

function Section:AddColorPicker(text, defaultColor, callback, opts)
    callback = callback or function() end
    opts = opts or {}
    defaultColor = defaultColor or Color3.fromRGB(255, 255, 255)

    local currentColor = defaultColor
    local currentH, currentS, currentV = Color3.toHSV(defaultColor)
    local pickerOpen = false

    local function hsvToRgb(h, s, v)
        return Color3.fromHSV(h, s, v)
    end

    local holder = New("Frame", {
        Parent = self._Inner,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 22),
    })

    local label = New("TextLabel", {
        Parent = holder,
        BackgroundTransparency = 1,
        Size = UDim2.new(0.5, 0, 1, 0),
        Font = KaylaUI.Theme.Font,
        Text = text or "Color Picker",
        TextColor3 = KaylaUI.Theme.Text,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
    })

    local previewButton = New("TextButton", {
        Parent = holder,
        AnchorPoint = Vector2.new(1, 0),
        Position = UDim2.new(1, 0, 0, 0),
        Size = UDim2.new(0.45, 0, 1, 0),
        BackgroundColor3 = currentColor,
        BorderSizePixel = 0,
        Text = "",
        AutoButtonColor = false,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(0, 6) }),
            New("UIStroke", { Color = KaylaUI.Theme.Outline, Thickness = 1 }),
        }
    })

    local pickerFrame = New("Frame", {
        Parent = self._Inner,
        BackgroundColor3 = KaylaUI.Theme.Section,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 0),
        ClipsDescendants = true,
        Visible = false,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(0, 6) }),
            New("UIStroke", { Color = KaylaUI.Theme.Outline, Thickness = 1 }),
            New("UIPadding", {
                PaddingLeft = UDim.new(0, 6),
                PaddingRight = UDim.new(0, 6),
                PaddingTop = UDim.new(0, 6),
                PaddingBottom = UDim.new(0, 6),
            }),
            New("UIListLayout", {
                Padding = UDim.new(0, 6),
                SortOrder = Enum.SortOrder.LayoutOrder,
            })
        }
    })

    local svFrame = New("Frame", {
        Parent = pickerFrame,
        Size = UDim2.new(1, 0, 0, 128),
        BackgroundColor3 = hsvToRgb(currentH, 1, 1),
        ClipsDescendants = true,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(0, 4) }),
            New("UIGradient", { -- Value gradient
                Color = ColorSequence.new(Color3.new(0, 0, 0), Color3.new(0, 0, 0)),
                Transparency = NumberSequence.new(1, 0),
                Rotation = 90,
            }),
            New("UIGradient", { -- Saturation gradient
                Color = ColorSequence.new(Color3.new(1, 1, 1), Color3.new(1, 1, 1)),
                Transparency = NumberSequence.new(0, 1),
            }),
        }
    })

    local svHandle = New("Frame", {
        Parent = svFrame,
        Size = UDim2.fromOffset(10, 10),
        AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundColor3 = Color3.new(1, 1, 1),
        BorderSizePixel = 0,
        ZIndex = 3,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(1, 0) }),
            New("UIStroke", { Color = Color3.new(0, 0, 0), Thickness = 2 }),
        }
    })

    local hueSlider = New("Frame", {
        Parent = pickerFrame,
        Size = UDim2.new(1, 0, 0, 20),
        BackgroundColor3 = Color3.new(1, 1, 1),
        ClipsDescendants = true,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(1, 0) }),
            New("UIGradient", {
                Color = ColorSequence.new({
                    ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 0, 0)),
                    ColorSequenceKeypoint.new(1/6, Color3.fromRGB(255, 255, 0)),
                    ColorSequenceKeypoint.new(2/6, Color3.fromRGB(0, 255, 0)),
                    ColorSequenceKeypoint.new(3/6, Color3.fromRGB(0, 255, 255)),
                    ColorSequenceKeypoint.new(4/6, Color3.fromRGB(0, 0, 255)),
                    ColorSequenceKeypoint.new(5/6, Color3.fromRGB(255, 0, 255)),
                    ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 0, 0)),
                })
            })
        }
    })

    local hueHandle = New("Frame", {
        Parent = hueSlider,
        Size = UDim2.new(0, 8, 1, 4),
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.new(currentH, 0, 0.5, 0),
        BackgroundColor3 = Color3.new(1, 1, 1),
        BorderSizePixel = 0,
        ZIndex = 3,
        Children = {
            New("UICorner", { CornerRadius = UDim.new(0, 2) }),
            New("UIStroke", { Color = Color3.new(0, 0, 0), Thickness = 2 }),
        }
    })

    local function UpdateColor()
        currentColor = hsvToRgb(currentH, currentS, currentV)
        previewButton.BackgroundColor3 = currentColor
        svFrame.BackgroundColor3 = hsvToRgb(currentH, 1, 1)
        task.spawn(callback, currentColor)
    end

    local function Set(color)
        currentColor = color
        currentH, currentS, currentV = Color3.toHSV(color)
        previewButton.BackgroundColor3 = currentColor
        svFrame.BackgroundColor3 = hsvToRgb(currentH, 1, 1)
        svHandle.Position = UDim2.new(currentS, 0, 1 - currentV, 0)
        hueHandle.Position = UDim2.new(currentH, 0, 0.5, 0)
    end

    Set(defaultColor)

    local svDragging = false
    local hueDragging = false

    local function UpdateSV(input)
        local absPos = svFrame.AbsolutePosition
        local absSize = svFrame.AbsoluteSize
        currentS = math.clamp((input.Position.X - absPos.X) / absSize.X, 0.01, 1)
        currentV = math.clamp(1 - (input.Position.Y - absPos.Y) / absSize.Y, 0.01, 1)
        svHandle.Position = UDim2.new(currentS, 0, 1 - currentV, 0)
        UpdateColor()
    end

    svFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            svDragging = true
            UpdateSV(input)
        end
    end)

    local function UpdateHue(input)
        local absPos = hueSlider.AbsolutePosition
        local absSize = hueSlider.AbsoluteSize
        currentH = math.clamp((input.Position.X - absPos.X) / absSize.X, 0, 1)
        hueHandle.Position = UDim2.new(currentH, 0, 0.5, 0)
        UpdateColor()
    end

    hueSlider.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            hueDragging = true
            UpdateHue(input)
        end
    end)

    UIS.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            if svDragging then UpdateSV(input) end
            if hueDragging then UpdateHue(input) end
        end
    end)

    UIS.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            svDragging = false
            hueDragging = false
        end
    end)

    previewButton.MouseButton1Click:Connect(function()
        pickerOpen = not pickerOpen
        pickerFrame.Visible = pickerOpen
        TweenService:Create(pickerFrame, TweenInfo.new(0.2), {
            Size = UDim2.new(1, 0, 0, pickerOpen and 160 or 0)
        }):Play()
    end)

    local flag = makeFlag(self, text or "ColorPicker", "Color", opts)
    KaylaUI:_RegisterControl({
        Flag = flag,
        Type = "color",
        Get = function() return currentColor end,
        Set = Set,
    })

    return {
        Get = function() return currentColor end,
        Set = Set,
    }
end

--// KAYLAUI MOBILE UI ENHANCEMENTS (NON-DESTRUCTIVE)

task.spawn(function()
    repeat task.wait() until Kayla_GetDevice

    if Kayla_GetDevice() ~= "Mobile" then return end

    local UIS = game:GetService("UserInputService")
    local TweenService = game:GetService("TweenService")
    local gui = (gethui and gethui()) or game:GetService("CoreGui")

    local bubble = Instance.new("TextButton")
    bubble.Name = "KaylaUI_FloatingBubble"
    bubble.Size = UDim2.fromOffset(52, 52)
    bubble.Position = UDim2.new(0, 20, 0.5, -26)
    bubble.BackgroundColor3 = Color3.fromRGB(60,60,70)
    bubble.Text = "â˜°"
    bubble.Font = Enum.Font.GothamBold
    bubble.TextSize = 24
    bubble.TextColor3 = Color3.new(1,1,1)
    bubble.BorderSizePixel = 0
    bubble.Visible = false
    Instance.new("UICorner", bubble).CornerRadius = UDim.new(1,0)
    bubble.Parent = gui

    local dragging, dragOffset

    bubble.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragOffset = bubble.Position - UDim2.fromOffset(input.Position.X, input.Position.Y)
        end
    end)

    UIS.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.Touch then
            bubble.Position = UDim2.fromOffset(
                input.Position.X + dragOffset.X.Offset,
                input.Position.Y + dragOffset.Y.Offset
            )
        end
    end)

    UIS.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
            local x = bubble.Position.X.Offset
            local snapX = x < workspace.CurrentCamera.ViewportSize.X / 2 and 12 or workspace.CurrentCamera.ViewportSize.X - 64
            TweenService:Create(bubble, TweenInfo.new(0.25), {
                Position = UDim2.fromOffset(snapX, bubble.Position.Y.Offset)
            }):Play()
        end
    end)

    local function hookWindows()
        for _, g in ipairs(gui:GetChildren()) do
            if g:IsA("ScreenGui") and g.Name:find("Kayla") then
                for _, f in ipairs(g:GetDescendants()) do
                    if f:IsA("Frame") and f.Size.X.Offset > 400 then
                        f.Size = UDim2.fromOffset(360, 420)
                        bubble.Visible = true

                        bubble.MouseButton1Click:Connect(function()
                            f.Visible = not f.Visible
                        end)
                    end
                end
            end
        end
    end

    task.wait(1)
    hookWindows()
end)

--// END MOBILE ENHANCEMENTS

return KaylaUI
